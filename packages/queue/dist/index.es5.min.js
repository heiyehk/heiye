!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).__Queue__=e()}(this,(function(){"use strict";var __assign=function(){return __assign=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},__assign.apply(this,arguments)},__awaiter=function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},__generator=function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},__read=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,s=n.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}return o},__spreadArray=function(t,e,n){if(n||2===arguments.length)for(var r,i=0,s=e.length;i<s;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))},getAccessType=function(t){return Object.prototype.toString.call(t).slice(8,-1)},isNullOrUndefined=function(t){return null==t},Queue=function(){function t(t,e){this.status="stop",this.cacheList=[],this.waitList=[],this.runningList=[],this.resultList=[],this.runningIndex=0,this.maxConcurrency=6,this.maxQueue=1,this.timeout=1e3,this.retry=3,this.retryDelay=1e3,this.retryBackoff=1,this.retryJitter=1,this.retryMaxDelay=1e3,this.retryMaxAttempts=3,this.retryHandle=function(t,e){return!0},this.retryFilter=function(t,e){return!0},this.retryTimeout=1e3,this.retryOnTimeout=!0,this.events={},this.allowStart=["stop","pause","resume","error","timeout"],this.notAllowStart=["start","running"],this.allowStop=["start","running","pause","resume","error","timeout"],this.allowPause=["running","error","timeout"],this.allowResume=["pause","error","timeout"],"Object"===getAccessType(t)?this.init(t):this.init(__assign({waitList:t},e))}return t.prototype.init=function(t){var e=__spreadArray([],__read(t.waitList||this.cacheList),!1).map((function(t,e){return{_id:e,fn:t}}));this.cacheList=__spreadArray([],__read(e),!1),this.waitList=e,this.maxConcurrency=t.maxConcurrency||this.maxConcurrency,this.maxQueue=t.maxQueue||this.maxQueue,this.timeout=t.timeout||this.timeout,this.retry=t.retry||this.retry,this.retryDelay=t.retryDelay||this.retryDelay,this.retryBackoff=t.retryBackoff||this.retryBackoff,this.retryJitter=t.retryJitter||this.retryJitter,this.retryMaxDelay=t.retryMaxDelay||this.retryMaxDelay,this.retryMaxAttempts=t.retryMaxAttempts||this.retryMaxAttempts,this.retryHandle=t.retryHandle||this.retryHandle,this.retryFilter=t.retryFilter||this.retryFilter,this.retryTimeout=t.retryTimeout||this.retryTimeout,this.retryOnTimeout=t.retryOnTimeout||this.retryOnTimeout,this.runningList=this.waitList.splice(0,this.maxConcurrency)},t.prototype.on=function(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)},t.prototype.start=function(){if(this.notAllowStart.includes(this.status))throw new Error("当前状态为".concat(this.status,"，不允许执行start"));this.status="start",this.runOnEvent("start"),this.run()},t.prototype.stop=function(){console.log("stop")},t.prototype.pause=function(){console.log("pause")},t.prototype.resume=function(){console.log("resume")},t.prototype.add=function(t){console.log(t)},t.prototype.remove=function(t){console.log(t)},t.prototype.clear=function(){console.log("clear")},t.prototype.run=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return this.allowStart.includes(this.status)?[2]:(this.status="running",this.runOnEvent("running"),[4,this.traverseRunningList()]);case 1:return t.sent(),[2]}}))}))},t.prototype.fnToPromiseFn=function(t){return new Promise((function(e,n){try{e(t())}catch(t){n(t)}}))},t.prototype.operationalFn=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n,r,i;return __generator(this,(function(s){switch(s.label){case 0:return"Function"===getAccessType(t.fn)?[3,2]:(r=(n=console).log,[4,t.fn]);case 1:return r.apply(n,[s.sent(),this.runningIndex]),[2,new Error("".concat(t.fn.toString()," is not a function, the subscript is ").concat(this.runningIndex))];case 2:return[4,this.fnToPromiseFn(t.fn).then((function(t){return t}))];case 3:e=s.sent(),this.runOnEvent("success",e),s.label=4;case 4:return this.resultList[t._id]=e,this.runningList.splice(this.runningList.findIndex((function(e){return e._id===t._id})),1),this.runningIndex++,this.waitList.length>0&&this.runningIndex<=this.cacheList.length-1&&(i=this.waitList.shift(),this.runningList.push(i),this.operationalFn(i)),0===this.waitList.length&&0===this.runningList.length&&(this.status="finish",this.runningIndex=0,this.runOnEvent("finish",this.resultList)),[2]}}))}))},t.prototype.traverseRunningList=function(){return __awaiter(this,void 0,void 0,(function(){var t,e,n,r,i;return __generator(this,(function(s){switch(s.label){case 0:t=0,s.label=1;case 1:return t<this.maxConcurrency?(e=this.runningList[t],this.runningIndex<this.cacheList.length?isNullOrUndefined(e.fn)?(r=(n=console).log,[4,e.fn]):[3,3]:[3,4]):[3,5];case 2:r.apply(n,[s.sent()]),this.runOnEvent("error",new Error("".concat(e.fn.toString()," is undefined, the subscript is ").concat(this.runningIndex))),s.label=3;case 3:if(i=this.operationalFn(e))throw i;s.label=4;case 4:return t++,[3,1];case 5:return[2]}}))}))},t.prototype.runOnEvent=function(t){for(var e,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];if(this.events[t]&&this.events[t].length)for(var i=0;i<this.events[t].length;i++)(e=this.events[t])[i].apply(e,__spreadArray([],__read(n),!1))},t}(),a=[],aaa=function(t){return new Promise((function(e){setTimeout((function(){e(t)}),1e3)}))};a.push(aaa("aaaaaaaaa"));for(var jsAsyncTemp=function(){return new Promise((function(t){setTimeout((function(){t("{{code}}")}),1e3)}))},jsSyncTemp=function(){return"{{code}}"},i=0;i<10;i++){var sc=String.fromCharCode(65+i),s=jsSyncTemp.toString().replace("{{code}}",sc);i%2==0&&(s=jsAsyncTemp.toString().replace("{{code}}",sc)),a.push(eval("(".concat(s,")")))}var queue=new Queue(a,{maxConcurrency:1}),start_time=0,end_time=0;return queue.on("start",(function(){start_time=performance.now()})),queue.on("finish",(function(t){console.log("finish===",t),end_time=performance.now(),console.log("耗时："+(end_time-start_time)+"微秒。")})),queue.start(),Queue}));
