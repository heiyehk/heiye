!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).__Queue__=n()}(this,(function(){"use strict";var t=function(){return t=Object.assign||function(t){for(var n,i=1,r=arguments.length;i<r;i++)for(var e in n=arguments[i])Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e]);return t},t.apply(this,arguments)},n=function(t,n,i,r){return new(i||(i=Promise))((function(e,s){function o(t){try{h(r.next(t))}catch(t){s(t)}}function u(t){try{h(r.throw(t))}catch(t){s(t)}}function h(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(t){t(n)}))).then(o,u)}h((r=r.apply(t,n||[])).next())}))},i=function(t,n){var i,r,e,s,o={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]};return s={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function u(s){return function(u){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,r&&(e=2&s[0]?r.return:s[0]?r.throw||((e=r.return)&&e.call(r),0):r.next)&&!(e=e.call(r,s[1])).done)return e;switch(r=0,e&&(s=[2&s[0],e.value]),s[0]){case 0:case 1:e=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(e=o.trys,(e=e.length>0&&e[e.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!e||s[1]>e[0]&&s[1]<e[3])){o.label=s[1];break}if(6===s[0]&&o.label<e[1]){o.label=e[1],e=s;break}if(e&&o.label<e[2]){o.label=e[2],o.ops.push(s);break}e[2]&&o.ops.pop(),o.trys.pop();continue}s=n.call(t,o)}catch(t){s=[6,t],r=0}finally{i=e=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}},r=function(t,n){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,e,s=i.call(t),o=[];try{for(;(void 0===n||n-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(t){e={error:t}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(e)throw e.error}}return o},e=function(t,n,i){if(i||2===arguments.length)for(var r,e=0,s=n.length;e<s;e++)!r&&e in n||(r||(r=Array.prototype.slice.call(n,0,e)),r[e]=n[e]);return t.concat(r||Array.prototype.slice.call(n))},s=function(t){return Object.prototype.toString.call(t).slice(8,-1)},o=function(){function o(n,i){this.waitList=[],this.maxConcurrency=6,this.retryCount=0,this.status="stop",this.cacheList=[],this.runningList=[],this.resultList=[],this.runningIndex=0,this.events={},this.allowStart=["stop","pause","error","timeout"],this.notAllowStart=["start","running"],"Object"===s(n)?this.init(n):this.init(t({waitList:n},i))}return o.prototype.fillAttribute=function(t){return t.map((function(t,n){return{fn:t,_id:n}}))},o.prototype.init=function(t){var n=this.fillAttribute(e([],r(t.waitList||this.cacheList),!1));this.cacheList=e([],r(n),!1),this.waitList=e([],r(n),!1),this.maxConcurrency=t.maxConcurrency||this.maxConcurrency,this.runningList=this.waitList.splice(0,this.maxConcurrency),this.retryCount=t.retryCount||this.retryCount},o.prototype.on=function(t,n){this.events[t]||(this.events[t]=[]),this.events[t].push(n)},o.prototype.start=function(){if(this.notAllowStart.includes(this.status))throw new Error("当前状态为".concat(this.status,"，不允许执行start"));this.status="start",this.runOnEvent("start"),this.run()},o.prototype.stop=function(t){void 0===t&&(t=!1),this.status="stop",t&&this.finishEvent()},o.prototype.pause=function(){this.status="pause"},o.prototype.resume=function(){return n(this,void 0,void 0,(function(){return i(this,(function(t){return this.status="resume",this.traverseRunningList(),[2]}))}))},o.prototype.add=function(t,n){if(void 0===n){var i={_id:this.cacheList.length,fn:t};this.cacheList.push(i),this.waitList.push(i)}else this.waitList.splice(n,0,{_id:n,fn:t})},o.prototype.remove=function(t){t?this.waitList=this.waitList.filter((function(n){return n.fn.toString()!==t.toString()})):this.runningList.length&&(this.waitList.length&&this.waitList.pop(),this.runningList.pop(),this.cacheList.pop())},o.prototype.clear=function(){this.waitList=[],this.runningList=[],this.cacheList=[],this.resultList=[],this.runningIndex=0},o.prototype.run=function(){return n(this,void 0,void 0,(function(){return i(this,(function(t){return this.allowStart.includes(this.status)||(this.status="running",this.runOnEvent("running"),this.traverseRunningList()),[2]}))}))},o.prototype.operationalFn=function(t){return n(this,void 0,void 0,(function(){var n,r;return i(this,(function(i){switch(i.label){case 0:return this.allowStart.includes(this.status)?[2]:"function"!=typeof t.fn?[2,new Error("".concat(t.fn," is not a function, the subscript is ").concat(this.runningIndex))]:[4,t.fn()];case 1:if(n=i.sent(),"Error"===s(n)&&this.retryCount&&(!t._retryCount||t._retryCount<this.retryCount))t._retryCount=t._retryCount?t._retryCount+1:1,this.operationalFn(t);else{if("running"!==this.status||t._remove||this.runOnEvent("success",n,t._id),this.resultList[t._id]=n,this.runningIndex++,this.runningList.splice(this.runningList.findIndex((function(n){return n._id===t._id})),1),this.allowStart.includes(this.status)||t._remove)return[2];this.waitList.length>0&&(r=this.waitList.shift(),this.runningList.push(r),this.operationalFn(r)),this.runningIndex===this.cacheList.length&&this.finishEvent()}return[2]}}))}))},o.prototype.traverseRunningList=function(){return n(this,void 0,void 0,(function(){var t,n;return i(this,(function(i){for(t=0;t<this.maxConcurrency&&!this.allowStart.includes(this.status)&&(n=this.runningList[t]);t++)if(this.runningIndex<this.cacheList.length){if(null==n.fn)throw new Error("".concat(n.fn," is undefined, the subscript is ").concat(this.runningIndex));this.operationalFn(n)}return[2]}))}))},o.prototype.runOnEvent=function(t){for(var n,i=[],s=1;s<arguments.length;s++)i[s-1]=arguments[s];if(this.events[t]&&this.events[t].length)for(var o=0;o<this.events[t].length;o++)(n=this.events[t])[o].apply(n,e([],r(i),!1))},o.prototype.finishEvent=function(){this.status="finish",this.runningIndex=0,this.waitList=[],this.cacheList=[],this.runOnEvent("finish",this.resultList)},o}();return o}));
