!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).__Queue__=n()}(this,(function(){"use strict";var t=function(t){return Object.prototype.toString.call(t).slice(8,-1)},n=function(){return n=Object.assign||function(t){for(var n,i=1,r=arguments.length;i<r;i++)for(var s in n=arguments[i])Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s]);return t},n.apply(this,arguments)},i=function(t,n,i,r){return new(i||(i=Promise))((function(s,e){function o(t){try{h(r.next(t))}catch(t){e(t)}}function u(t){try{h(r.throw(t))}catch(t){e(t)}}function h(t){var n;t.done?s(t.value):(n=t.value,n instanceof i?n:new i((function(t){t(n)}))).then(o,u)}h((r=r.apply(t,n||[])).next())}))},r=function(t,n){var i,r,s,e,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function u(u){return function(h){return function(u){if(i)throw new TypeError("Generator is already executing.");for(;e&&(e=0,u[0]&&(o=0)),o;)try{if(i=1,r&&(s=2&u[0]?r.return:u[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,u[1])).done)return s;switch(r=0,s&&(u=[2&u[0],s.value]),u[0]){case 0:case 1:s=u;break;case 4:return o.label++,{value:u[1],done:!1};case 5:o.label++,r=u[1],u=[0];continue;case 7:u=o.ops.pop(),o.trys.pop();continue;default:if(!(s=o.trys,(s=s.length>0&&s[s.length-1])||6!==u[0]&&2!==u[0])){o=0;continue}if(3===u[0]&&(!s||u[1]>s[0]&&u[1]<s[3])){o.label=u[1];break}if(6===u[0]&&o.label<s[1]){o.label=s[1],s=u;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(u);break}s[2]&&o.ops.pop(),o.trys.pop();continue}u=n.call(t,o)}catch(t){u=[6,t],r=0}finally{i=s=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,h])}}},s=function(t,n){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,s,e=i.call(t),o=[];try{for(;(void 0===n||n-- >0)&&!(r=e.next()).done;)o.push(r.value)}catch(t){s={error:t}}finally{try{r&&!r.done&&(i=e.return)&&i.call(e)}finally{if(s)throw s.error}}return o},e=function(t,n,i){if(i||2===arguments.length)for(var r,s=0,e=n.length;s<e;s++)!r&&s in n||(r||(r=Array.prototype.slice.call(n,0,s)),r[s]=n[s]);return t.concat(r||Array.prototype.slice.call(n))},o=function(){function o(i,r){this.waitList=[],this.maxConcurrency=6,this.retryCount=0,this.status="stop",this.cacheList=[],this.runningList=[],this.resultList=[],this.runningIndex=0,this.events={},this.allowStart=["stop","pause","error"],this.notAllowStart=["start","running"],"Object"===t(i)?this.init(i):this.init(n({waitList:i},r))}return o.prototype.fillAttribute=function(t){return t.map((function(t,n){return{fn:t,_id:n}}))},o.prototype.init=function(t){var n=this.fillAttribute(e([],s(t.waitList||this.cacheList),!1));this.cacheList=e([],s(n),!1),this.waitList=e([],s(n),!1),this.maxConcurrency=t.maxConcurrency||this.maxConcurrency,this.runningList=this.waitList.splice(0,this.maxConcurrency),this.retryCount=t.retryCount||this.retryCount},o.prototype.on=function(t,n){this.events[t]?this.events[t].push(n):this.events[t]=[n]},o.prototype.start=function(){if(this.notAllowStart.includes(this.status))throw new Error("The current status is ".concat(this.status,", start is not allowed"));this.status="start",this.runOnEvent(this.status),this.run()},o.prototype.stop=function(t){return void 0===t&&(t=!1),i(this,void 0,void 0,(function(){return r(this,(function(n){return this.status="stop",this.runOnEvent(this.status),t&&this.finishEvent(),[2]}))}))},o.prototype.pause=function(){this.status="pause",this.runOnEvent(this.status)},o.prototype.resume=function(){this.status="resume",this.runOnEvent(this.status),this.traverseRunningList()},o.prototype.add=function(t,n){if(void 0===n){var i={_id:this.cacheList.length,fn:t};this.cacheList.push(i),this.waitList.push(i)}else this.waitList.splice(n,0,{_id:n,fn:t})},o.prototype.remove=function(t){t?this.waitList=this.waitList.filter((function(n){return n.fn.toString()!==t.toString()})):this.runningList.length&&(this.waitList.length&&this.waitList.pop(),this.runningList.pop(),this.cacheList.pop())},o.prototype.clear=function(){this.waitList=[],this.runningList=[],this.cacheList=[],this.resultList=[],this.runningIndex=0},o.prototype.run=function(){this.allowStart.includes(this.status)||(this.status="running",this.traverseRunningList())},o.prototype.operationalFn=function(n){return i(this,void 0,void 0,(function(){var i,s;return r(this,(function(r){switch(r.label){case 0:return this.allowStart.includes(this.status)?[2]:"function"!=typeof n.fn?[2,new Error("".concat(n.fn," is not a function, the subscript is ").concat(this.runningIndex))]:[4,n.fn()];case 1:if(i=r.sent(),this.runOnEvent("running",n._id),"Error"===t(i)&&this.retryCount&&(!n._retryCount||n._retryCount<this.retryCount))this.runOnEvent("error",i,n._id),n._retryCount=n._retryCount?n._retryCount+1:1,this.operationalFn(n);else{if(n._remove||this.runOnEvent("success",i,n._id),this.resultList[n._id]=i,this.runningIndex++,this.runningList.splice(this.runningList.findIndex((function(t){return t._id===n._id})),1),n._remove)return[2];this.waitList.length>0&&(s=this.waitList.shift(),this.runningList.push(s),this.operationalFn(s)),this.runningIndex===this.cacheList.length&&this.finishEvent()}return[2]}}))}))},o.prototype.traverseRunningList=function(){for(var t=0;t<this.maxConcurrency&&!this.allowStart.includes(this.status);t++){var n=this.runningList[t];if(!n)break;if(this.runningIndex<this.cacheList.length){if(null==n.fn){var i=new Error("".concat(n.fn," is undefined, the subscript is ").concat(this.runningIndex));throw this.runOnEvent("error",i,n._id),i}this.operationalFn(n)}}},o.prototype.runOnEvent=function(t){for(var n,i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];if(this.events[t]&&this.events[t].length)for(var o=0;o<this.events[t].length;o++)(n=this.events[t])[o].apply(n,e([],s(i),!1))},o.prototype.finishEvent=function(){this.status="finish",this.runningIndex=0,this.waitList=[],this.cacheList=[],this.runOnEvent("finish",this.resultList)},o}();return o}));
