!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).__Queue__=n()}(this,(function(){"use strict";var t=function(t){return Object.prototype.toString.call(t).slice(8,-1)},n=function(){return n=Object.assign||function(t){for(var n,i=1,e=arguments.length;i<e;i++)for(var s in n=arguments[i])Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s]);return t},n.apply(this,arguments)},i=function(t,n,i,e){return new(i||(i=Promise))((function(s,r){function o(t){try{a(e.next(t))}catch(t){r(t)}}function u(t){try{a(e.throw(t))}catch(t){r(t)}}function a(t){var n;t.done?s(t.value):(n=t.value,n instanceof i?n:new i((function(t){t(n)}))).then(o,u)}a((e=e.apply(t,n||[])).next())}))},e=function(t,n){var i,e,s,r,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return r={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function u(r){return function(u){return function(r){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,e&&(s=2&r[0]?e.return:r[0]?e.throw||((s=e.return)&&s.call(e),0):e.next)&&!(s=s.call(e,r[1])).done)return s;switch(e=0,s&&(r=[2&r[0],s.value]),r[0]){case 0:case 1:s=r;break;case 4:return o.label++,{value:r[1],done:!1};case 5:o.label++,e=r[1],r=[0];continue;case 7:r=o.ops.pop(),o.trys.pop();continue;default:if(!(s=o.trys,(s=s.length>0&&s[s.length-1])||6!==r[0]&&2!==r[0])){o=0;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){o.label=r[1];break}if(6===r[0]&&o.label<s[1]){o.label=s[1],s=r;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(r);break}s[2]&&o.ops.pop(),o.trys.pop();continue}r=n.call(t,o)}catch(t){r=[6,t],e=0}finally{i=s=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,u])}}},s=function(t,n){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var e,s,r=i.call(t),o=[];try{for(;(void 0===n||n-- >0)&&!(e=r.next()).done;)o.push(e.value)}catch(t){s={error:t}}finally{try{e&&!e.done&&(i=r.return)&&i.call(r)}finally{if(s)throw s.error}}return o},r=function(t,n,i){if(i||2===arguments.length)for(var e,s=0,r=n.length;s<r;s++)!e&&s in n||(e||(e=Array.prototype.slice.call(n,0,s)),e[s]=n[s]);return t.concat(e||Array.prototype.slice.call(n))},o=function(){function o(i,e){this.status="stop",this.cacheList=[],this.waitList=[],this.runningList=[],this.resultList=[],this.runningIndex=0,this.maxConcurrency=6,this.events={},this.allowStart=["stop","pause","error","timeout"],this.notAllowStart=["start","running"],"Object"===t(i)?this.init(i):this.init(n({waitList:i},e))}return o.prototype.fillAttribute=function(t){return t.map((function(t,n){return{fn:t,_id:n}}))},o.prototype.init=function(t){var n=this.fillAttribute(r([],s(t.waitList||this.cacheList),!1));this.cacheList=r([],s(n),!1),this.waitList=r([],s(n),!1),this.maxConcurrency=t.maxConcurrency||this.maxConcurrency,this.runningList=this.waitList.splice(0,this.maxConcurrency)},o.prototype.on=function(t,n){this.events[t]||(this.events[t]=[]),this.events[t].push(n)},o.prototype.start=function(){if(this.notAllowStart.includes(this.status))throw new Error("当前状态为".concat(this.status,"，不允许执行start"));this.status="start",this.runOnEvent("start"),this.run()},o.prototype.stop=function(t){void 0===t&&(t=!1),this.status="stop",t&&this.finishEvent()},o.prototype.pause=function(){this.status="pause"},o.prototype.resume=function(){return i(this,void 0,void 0,(function(){return e(this,(function(t){switch(t.label){case 0:return this.status="resume",[4,this.traverseRunningList()];case 1:return t.sent(),[2]}}))}))},o.prototype.add=function(t,n){if(void 0===n){var i={_id:this.cacheList.length,fn:t};this.cacheList.push(i),this.waitList.push(i)}else this.waitList.splice(n,0,{_id:n,fn:t})},o.prototype.remove=function(t){t?this.waitList=this.waitList.filter((function(n){return n.fn.toString()!==t.toString()})):this.runningList.length&&(this.waitList.length&&this.waitList.pop(),this.runningList.pop(),this.cacheList.pop(),console.log(this.waitList,this.runningList,this.cacheList))},o.prototype.clear=function(){console.log("clear")},o.prototype.run=function(){return i(this,void 0,void 0,(function(){return e(this,(function(t){switch(t.label){case 0:return this.allowStart.includes(this.status)?[2]:(this.status="running",this.runOnEvent("running"),[4,this.traverseRunningList()]);case 1:return t.sent(),[2]}}))}))},o.prototype.fnToPromiseFn=function(t){return new Promise((function(n,i){try{n(t())}catch(t){i(t)}}))},o.prototype.operationalFn=function(n){return i(this,void 0,void 0,(function(){var i,s;return e(this,(function(e){switch(e.label){case 0:return this.allowStart.includes(this.status)?[2]:"Function"===t(n.fn)?[3,1]:[2,new Error("".concat(n.fn," is not a function, the subscript is ").concat(this.runningIndex))];case 1:return"Function"!==t(n.fn)?[3,3]:[4,this.fnToPromiseFn(n.fn).then((function(t){return t}))];case 2:i=e.sent(),"running"!==this.status||n._remove||this.runOnEvent("success",i,n._id),e.label=3;case 3:return this.resultList[n._id]=i,"running"!==this.status||n._remove?[2]:(this.runningList.splice(this.runningList.findIndex((function(t){return t._id===n._id})),1),this.runningIndex++,!this.allowStart.includes(this.status)&&this.waitList.length>0&&this.runningIndex<=this.cacheList.length-1&&(s=this.waitList.shift(),this.runningList.push(s),this.operationalFn(s)),0===this.waitList.length&&0===this.runningList.length&&this.finishEvent(),[2])}}))}))},o.prototype.traverseRunningList=function(){return i(this,void 0,void 0,(function(){var n,i,s,r,o;return e(this,(function(e){switch(e.label){case 0:n=this.runningIndex,e.label=1;case 1:if(!(n<this.maxConcurrency))return[3,4];if(this.allowStart.includes(this.status))return[3,4];if(i=this.cacheList[n],!(this.runningIndex<this.cacheList.length))return[3,3];if(null==i.fn)throw s=new Error("".concat(i.fn," is undefined, the subscript is ").concat(this.runningIndex)),this.runOnEvent("error",s),s;return r=this.operationalFn(i),o=t,[4,r];case 2:if("Error"===o.apply(void 0,[e.sent()]))throw r;e.label=3;case 3:return n++,[3,1];case 4:return[2]}}))}))},o.prototype.runOnEvent=function(t){for(var n,i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];if(this.events[t]&&this.events[t].length)for(var o=0;o<this.events[t].length;o++)(n=this.events[t])[o].apply(n,r([],s(i),!1))},o.prototype.finishEvent=function(){this.status="finish",this.runningIndex=0,this.waitList=[],this.cacheList=[],this.runOnEvent("finish",this.resultList)},o}();return o}));
