!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).__Queue__=n()}(this,(function(){"use strict";var t=function(t){return Object.prototype.toString.call(t).slice(8,-1)},n=function(){return n=Object.assign||function(t){for(var n,i=1,s=arguments.length;i<s;i++)for(var r in n=arguments[i])Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r]);return t},n.apply(this,arguments)},i=function(t,n,i,s){return new(i||(i=Promise))((function(r,e){function o(t){try{h(s.next(t))}catch(t){e(t)}}function u(t){try{h(s.throw(t))}catch(t){e(t)}}function h(t){var n;t.done?r(t.value):(n=t.value,n instanceof i?n:new i((function(t){t(n)}))).then(o,u)}h((s=s.apply(t,n||[])).next())}))},s=function(t,n){var i,s,r,e,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return e={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function u(e){return function(u){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,s&&(r=2&e[0]?s.return:e[0]?s.throw||((r=s.return)&&r.call(s),0):s.next)&&!(r=r.call(s,e[1])).done)return r;switch(s=0,r&&(e=[2&e[0],r.value]),e[0]){case 0:case 1:r=e;break;case 4:return o.label++,{value:e[1],done:!1};case 5:o.label++,s=e[1],e=[0];continue;case 7:e=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==e[0]&&2!==e[0])){o=0;continue}if(3===e[0]&&(!r||e[1]>r[0]&&e[1]<r[3])){o.label=e[1];break}if(6===e[0]&&o.label<r[1]){o.label=r[1],r=e;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(e);break}r[2]&&o.ops.pop(),o.trys.pop();continue}e=n.call(t,o)}catch(t){e=[6,t],s=0}finally{i=r=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,u])}}},r=function(t,n){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var s,r,e=i.call(t),o=[];try{for(;(void 0===n||n-- >0)&&!(s=e.next()).done;)o.push(s.value)}catch(t){r={error:t}}finally{try{s&&!s.done&&(i=e.return)&&i.call(e)}finally{if(r)throw r.error}}return o},e=function(t,n,i){if(i||2===arguments.length)for(var s,r=0,e=n.length;r<e;r++)!s&&r in n||(s||(s=Array.prototype.slice.call(n,0,r)),s[r]=n[r]);return t.concat(s||Array.prototype.slice.call(n))},o=function(){function o(i,s){this.waitList=[],this.maxConcurrency=6,this.retryCount=0,this.status="stop",this.cacheList=[],this.runningList=[],this.resultList=[],this.runningIndex=0,this.events={},this.allowStart=["stop","pause","error"],this.notAllowStart=["start","running"],"Object"===t(i)?this.init(i):this.init(n({waitList:i},s))}return o.prototype.fillAttribute=function(t){return t.map((function(t,n){return{fn:t,_id:n}}))},o.prototype.init=function(t){var n=this.fillAttribute(e([],r(t.waitList||this.cacheList),!1));this.cacheList=e([],r(n),!1),this.waitList=e([],r(n),!1),this.maxConcurrency=t.maxConcurrency||this.maxConcurrency,this.runningList=this.waitList.splice(0,this.maxConcurrency),this.retryCount=t.retryCount||this.retryCount},o.prototype.on=function(t,n){this.events[t]||(this.events[t]=[]),this.events[t].push(n)},o.prototype.start=function(){if(this.notAllowStart.includes(this.status))throw new Error("The current status is ".concat(this.status,", start is not allowed"));this.status="start",this.runOnEvent(this.status),this.run()},o.prototype.stop=function(t){void 0===t&&(t=!1),this.status="stop",this.runOnEvent(this.status),t&&this.finishEvent()},o.prototype.pause=function(){this.status="pause",this.runOnEvent(this.status)},o.prototype.resume=function(){return i(this,void 0,void 0,(function(){return s(this,(function(t){return this.status="resume",this.runOnEvent(this.status),this.traverseRunningList(),[2]}))}))},o.prototype.add=function(t,n){if(void 0===n){var i={_id:this.cacheList.length,fn:t};this.cacheList.push(i),this.waitList.push(i)}else this.waitList.splice(n,0,{_id:n,fn:t})},o.prototype.remove=function(t){t?this.waitList=this.waitList.filter((function(n){return n.fn.toString()!==t.toString()})):this.runningList.length&&(this.waitList.length&&this.waitList.pop(),this.runningList.pop(),this.cacheList.pop())},o.prototype.clear=function(){this.waitList=[],this.runningList=[],this.cacheList=[],this.resultList=[],this.runningIndex=0},o.prototype.run=function(){return i(this,void 0,void 0,(function(){return s(this,(function(t){return this.allowStart.includes(this.status)||(this.status="running",this.runOnEvent(this.status),this.traverseRunningList()),[2]}))}))},o.prototype.operationalFn=function(n){return i(this,void 0,void 0,(function(){var i,r;return s(this,(function(s){switch(s.label){case 0:return this.allowStart.includes(this.status)?[2]:"function"!=typeof n.fn?[2,new Error("".concat(n.fn," is not a function, the subscript is ").concat(this.runningIndex))]:[4,n.fn()];case 1:if(i=s.sent(),"Error"===t(i)&&this.retryCount&&(!n._retryCount||n._retryCount<this.retryCount))this.runOnEvent("error",i,n._id),n._retryCount=n._retryCount?n._retryCount+1:1,this.operationalFn(n);else{if("running"!==this.status||n._remove||this.runOnEvent("success",i,n._id),this.resultList[n._id]=i,this.runningIndex++,this.runningList.splice(this.runningList.findIndex((function(t){return t._id===n._id})),1),this.allowStart.includes(this.status)||n._remove)return[2];this.waitList.length>0&&(r=this.waitList.shift(),this.runningList.push(r),this.operationalFn(r)),this.runningIndex===this.cacheList.length&&this.finishEvent()}return[2]}}))}))},o.prototype.traverseRunningList=function(){return i(this,void 0,void 0,(function(){var t,n,i;return s(this,(function(s){for(t=0;t<this.maxConcurrency&&!this.allowStart.includes(this.status)&&(n=this.runningList[t]);t++)if(this.runningIndex<this.cacheList.length){if(null==n.fn)throw i=new Error("".concat(n.fn," is undefined, the subscript is ").concat(this.runningIndex)),this.runOnEvent("error",i,n._id),i;this.operationalFn(n)}return[2]}))}))},o.prototype.runOnEvent=function(t){for(var n,i=[],s=1;s<arguments.length;s++)i[s-1]=arguments[s];if(this.events[t]&&this.events[t].length)for(var o=0;o<this.events[t].length;o++)(n=this.events[t])[o].apply(n,e([],r(i),!1))},o.prototype.finishEvent=function(){this.status="finish",this.runningIndex=0,this.waitList=[],this.cacheList=[],this.runOnEvent("finish",this.resultList)},o}();return o}));
